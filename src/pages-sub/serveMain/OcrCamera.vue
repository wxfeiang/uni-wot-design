<route lang="json5" type="page">
{
  layout: 'default',
  needLogin: true,
  style: {
    navigationStyle: 'custom',
  },
}
</route>
<script lang="ts" setup>
import { useBaseStore } from '@/store'
import { useToast } from 'wot-design-uni'

const { setCameraData } = useBaseStore()

const toast = useToast()

const cameraContext = ref(null)

const dataList = ref([
  {
    title: '人脸正面照片',
    imgType: 0,
    devicePosition: 'front',
  },
  {
    title: '身份证人像面',
    imgType: 1,
    devicePosition: 'back',
  },
  {
    title: '身份证国徽面',
    imgType: 2,
    devicePosition: 'back',
  },
])

const emit = defineEmits(['getImgPath', 'colseCamera'])

const currData = ref()
onLoad((options: any) => {
  console.log('🥑============')
  const { photoType } = options
  console.log('🍵[photoType]:', photoType)

  currData.value = dataList.value.find((item) => {
    return item.imgType === photoType * 1
  })
  console.log('🍛[ currData.value ]:', currData.value)
})

onMounted(() => {
  if (uni.createCameraContext) {
    cameraContext.value = uni.createCameraContext()
  } else {
    toast.error('当前微信版本过低，无法使用该功能，请升级到最新微信版本后重试。')
  }
})
// onBeforeUnmount(() => {
//   uni.stopGyroscope({
//     success() {
//       console.log('stop success!')
//     },
//     fail() {
//       console.log('stop fail!')
//     },
//   })
//   uni.stopDeviceMotionListening()
// })
function cameraError(e) {
  console.log(e.detail)
  // wx.showToast({
  //   title: '以拒绝，使用请手动开启',
  //   icon: 'none',
  // })
  toast.error('以拒绝，使用请手动开启')
  setTimeout(() => {
    wx.navigateBack({
      delta: 1, // 返回上一级页面
    })
  }, 3000)
}

const takePhoto = () => {
  cameraContext.value.takePhoto({
    quality: 'high',

    success: (res) => {
      toast.loading('正在上传中...')
      uni.compressImage({
        src: res.tempImagePath,
        quality: 90, // 压缩比例
        success: async (ress: any) => {
          console.log('🍢[ress]:', ress, ress.tempFilePath)
          // const photoBase64 = await pathToBase64(ress.tempFilePath)

          // const size = getBase64ImageSize(photoBase64)
          // console.log('🍔', size)
          // if (size > 1024 * 80) {
          //   message.alert('图片大小超过限制，请重新拍摄')
          //   return
          // }
          const ingmUrl = ress.tempFilePath
          const data = {
            url: ress.tempFilePath,
            id: '1',
            data: {},
          }
          setCameraData(currData.value.imgType, data)
          close()
          // const formData = {
          //   ...currentParams.value,
          //   zjhm: '31242520311264800',
          //   photoBase64: photoBase64.replace('data:image/png;', 'data:image/jpg;'),
          // }
          // console.log('🌰', formData, ingmUrl)
          // try {
          //   const resData: any = await sendPhoto(formData)
          //   if (resData.data.data.message || resData.data.code === 500) {
          //     toast.erro(resData.data.data.message || resData.data.msg)
          //      toast.close()
          //   } else {
          //     // console.log('🍦[resData]:', resData.data.data.identifyCardInfo)
          //     // basestore.cameraData = resData.data.data
          //     close()
          //     toast.close()
          //   }
          // } catch (error) {
          //   toast.error('图片上传出问题了')
          //    toast.close()
          // }

          // 调用上传接口 -----
        },
      })
    },
    fail: (err) => {
      console.log('🍚[err]:', err)
      toast.error('图片拍照失败')
      toast.close()
    },
  })
}
// 从相册选取
const chooseImage = () => {
  uni.chooseImage({
    count: 1,
    sizeType: ['original', 'compressed'],
    sourceType: ['album'],
    success: (res) => {
      console.log('相册选取成功', res)
      emit('getImgPath', res.tempFilePaths[0])
    },
    fail: (err) => {
      console.log('相册选取失败', err)
    },
  })
}
function reverseCamera() {
  currData.value.devicePosition = currData.value.devicePosition === 'back' ? 'front' : 'back'
}
// 关闭相机
const close = () => {
  toast.close()
  uni.navigateBack()
}
</script>
<template>
  <view class="h-90vh">
    <camera
      mode="normal"
      :device-position="currData.devicePosition"
      flash="auto"
      class="w-full h-90vh"
      binderror="cameraError"
    >
      <cover-view class="size-100% flex flex-col justify-center items-center">
        <!-- 人脸面 -->
        <cover-image
          v-if="currData.imgType == 0"
          class="w-full h-700rpx"
          src="https://img-blog.csdnimg.cn/20210126152753150.png"
        />
        <!-- 正面 -->
        <cover-image
          v-if="currData.imgType == 1"
          class="w-300px h-400px"
          src="https://img.jbzj.com/file_images/article/202009/202099172501721.png"
        />

        <wd-toast />
      </cover-view>
    </camera>
    <view class="w-full h-10vh bg-#000 font-size-20px color-#fff">
      <view class="flex justify-between items-center px-70px py-10px">
        <view class="back" @click="close">
          <wd-icon name="arrow-down" size="22px" color="#fff"></wd-icon>
        </view>
        <view @click="takePhoto" hover-class="color-red">
          <view class="i-carbon-circle-filled font-size-50px color-#fff"></view>
        </view>
        <view @click="reverseCamera">
          <wd-icon name="refresh1" size="22px" color="#fff"></wd-icon>
        </view>
      </view>
    </view>
  </view>
</template>

<style lang="scss" scoped></style>
