<route lang="json5" type="page">
{
  layout: 'default',
  needLogin: true,
  style: {
    navigationStyle: 'custom',
  },
}
</route>

<script lang="ts" setup>
// import { useRequest } from 'alova/client'
// TODO: 背景图片
import tmQrcode from '@/components/dy-qrcode/dy-qrcode.vue'
import lPainter from '@/components/lime-painter/components/l-painter/l-painter.vue'
import { Constant } from '@/enums/constant'
import { NAVIGATE_TYPE } from '@/enums/routerEnum'
import { useUserStore } from '@/store'
import { routeTo, sceneResult } from '@/utils'
import PLATFORM from '@/utils/platform'
import { downSaveImage, useScancode } from '@/utils/uniapi'
import { storeToRefs } from 'pinia'
import qs from 'qs'
import { useMessage } from 'wot-design-uni'
import hb from '../static/images/coupon/hb.png'
import wx from '../static/images/coupon/wx.png'
import CouponList from './components/couponList.vue'
import { conponListProps } from './utils/types'
import userCoupon from './utils/userCoupon'

const { isLogined, userInfo } = storeToRefs(useUserStore())
const message = useMessage()
const { VITE_SERVER_BASEURL } = import.meta.env
const { VITE_APP_LOGOTITLE } = import.meta.env
const { sendCouponInfo, couponInfoData } = userCoupon()
const qrcode = ref<InstanceType<typeof tmQrcode> | null>(null)
const cfigSatatus = ref(false)
const show = ref(false)
const cfig = ref({
  str: '', // 要生成二维码的字符串
  size: 300,
})
const shareQbg = ref(
  'https://oss.xay.xacloudy.cn/images/2024-10/5abaa059-f847-4b9f-b2a1-083d082498e3qbg.png',
)
const path = ref('')
const share = async () => {
  show.value = true
}

const showHb = ref(false)
const painter = ref()
const couponPrice =
  couponInfoData.value.couponType === 3
    ? couponInfoData.value.couponPrice * 10
    : couponInfoData.value.couponPrice
const company = couponInfoData.value.couponType === 3 ? '折' : '¥'
const couponFillPrice =
  couponInfoData.value.couponFillPrice > 0
    ? '满' + couponInfoData.value.couponFillPrice + '元可用'
    : '无门槛'
const poster = ref({
  css: {
    width: '750rpx',
    margin: '0 auto',
    background: '#D51710',
    backgroundRepeat: 'no-repeat',
    padding: '0 20px',
    borderRadius: '5px',
  },
  views: [
    {
      text: couponInfoData.value.couponName,
      type: 'text',
      css: {
        display: 'block',
        textAlign: 'center',
        padding: '20px 0 ',
        color: '#fff',
        fontSize: '20px',
      },
    },
    {
      type: 'view',
      css: {
        display: 'block',
        textAlign: 'center',
        padding: '20px 0 ',
        lineHeight: '100px',
      },
      views: [
        {
          text: couponPrice,
          type: 'text',
          css: {
            color: '#FFECBA',
            fontSize: '80px',
            lineHeight: '100px',
            fontWeight: '600',
            verticalAlign: 'bottom',
          },
        },
        {
          text: company,
          type: 'text',
          css: {
            color: '#FFECBA',
            fontSize: '30px',
            fontWeight: '600',
            lineHeight: '20px',
            verticalAlign: 'bottom',
          },
        },
      ],
    },
    {
      text: couponFillPrice,
      type: 'text',
      css: {
        display: 'block',
        textAlign: 'center',
        padding: '20px 0 ',
        color: '#fff',
        fontSize: '24px',
        fontWeight: '600',
      },
    },
    {
      type: 'view',
      css: {
        display: 'block',
        textAlign: 'center',
        padding: '20px 0 ',
        color: '#fff',
      },
      views: [
        {
          type: 'qrcode',
          text: 'limeui.qcoon.cn',
          css: {
            width: '200px',
            height: '100px',
            margin: '0 auto',
            padding: '10px',
          },
        },
      ],
    },
  ],
})
const downLoadQrcode = () => {
  showHb.value = true
  console.log('🥑', poster.value)
  painter.value.render(poster.value)
  painter.value.canvasToTempFilePathSync({
    // 在nvue里是jpeg
    fileType: 'jpg',
    quality: 1,
    success: (res) => {
      // 非H5 保存到相册
      // H5 提示用户长按图另存
      // setTimeout(() => {
      //   show.value = false
      // }, 3000)

      // #ifndef  H5
      downSaveImage(res.tempFilePath)
      // #endif
    },
  })
}
const btnClick2 = async (item) => {
  if (item.action === 'lq') {
    routeTo({ url: '/pages-sub/marketManager/coupon/coupDeil', navType: NAVIGATE_TYPE.REDIRECT_TO })
  } else if (item.action === 'myCoupon') {
    routeTo({ url: '/pages-sub/marketManager/coupon/mycoupon', navType: NAVIGATE_TYPE.REDIRECT_TO })
  } else if (item.action === 'useCoupon') {
    // 点击分享

    if (couponInfoData.value.type === 1) {
      const resData: any = await useScancode({ onlyFromCamera: true })
      const { status, url } = sceneResult(resData)
      if (status) {
        routeTo({
          url: '/pages/pay/index',
          data: { url },
        })
      } else {
        message.alert({
          msg: '未识别到二维码内容',
          title: '提示',
        })
      }
    }
    if (couponInfoData.value.type === 2) {
      routeTo({ url: '/pages/shop/index', navType: NAVIGATE_TYPE.SWITCH_TAB })
    }
    if (couponInfoData.value.type === 3) {
      cfigSatatus.value = true
    }
  }
}
const footerBtns1 = ref([
  {
    text: '领券中心',
    size: 'medium',
    round: false,
    plain: true,
    type: 'error',
    action: 'lq',
    customClass: 'custom-class-error-dyplain',
  },
  {
    text: '立即领取',
    size: 'medium',
    round: false,
    type: 'error',
    action: 'useCoupon',
    customClass: 'custom-class-mine-error',
  },
])

const footerBtns3 = ref([
  {
    text: '我的优惠券',
    size: 'medium',
    round: false,
    plain: true,
    type: 'error',
    action: 'myCoupon',
    customClass: 'custom-class-error-dyplain',
  },
  {
    text: '立即使用',
    size: 'medium',
    round: false,
    type: 'error',
    action: 'useCoupon',
    customClass: 'custom-class-mine-error',
  },
])
const footbtn = computed(() => {
  return isLogined.value ? footerBtns3.value : footerBtns1.value
})
const handleClose = () => {
  show.value = false
}
const wexinClick = () => {
  if (PLATFORM.platform === 'h5') {
    console.log('🥧')
  } else {
    console.log('🍲')
  }
}

onLoad(async (options) => {
  console.log('🥧======', options)
  try {
    await sendCouponInfo({ couponCode: options.couponCode })
    const qrcodeData = {
      couponCode: options.couponCode,
      qrCodeType: Constant.QR_CODE_FLAG,
      actionType: Constant.QR_CODE_PAY,
    }
    cfig.value.str = `${VITE_SERVER_BASEURL}?${qs.stringify(qrcodeData)}`
  } catch (error) {
    couponInfoData.value = {} as conponListProps
    message.alert({ title: '提示', msg: error.data.msg, closeOnClickModal: false }).then((res) => {
      uni.navigateBack()
    })
  }
})

onShareAppMessage((res) => {
  if (res.from === 'button' || res.from === 'menu') {
    // 来自页面内分享按钮
    return {
      title: VITE_APP_LOGOTITLE,
      summary: '我抢到优惠券啦!快来一起抢，名额有限!',
      imageUrl: shareQbg.value,
      path: '/pages/test/test?id=123',
    }
  }
})
</script>

<template>
  <view class="min-h-100vh">
    <dy-navbar leftTitle="优惠券详情" left></dy-navbar>
    <view class="px-15px">
      <view class="isShadow rounded-10px">
        <view class="mx-[-15px]">
          <Coupon-List
            :data="couponInfoData"
            :actionShow="false"
            :isShare="true"
            :detil="false"
            @share="share"
          ></Coupon-List>
        </view>

        <view class="pb-30px" v-if="couponInfoData.type === 3 && cfigSatatus && isLogined">
          <view class="py-10px text-16px text-center">券码：{{ couponInfoData.couponCode }}</view>
          <view class="flex justify-center mt-10px flex-col items-center">
            <dy-qrcode ref="qrcode" :option="cfig"></dy-qrcode>
          </view>
        </view>
      </view>
      <view>
        <view class="text-14px p-15px mt-20px" v-if="couponInfoData.couponRemark">
          <view class="color-#000 text-16px">使用说明</view>
          <view class="color-#777777 mt-5px">{{ couponInfoData.couponRemark }}</view>
        </view>
      </view>
    </view>
    <view class="fixed bottom-3 left-0 right-0 px-20px">
      <view class="flex gap-15px mt-20px">
        <view class="flex-1" v-for="(item, index) in footbtn" :key="index">
          <wd-button
            :round="item.round"
            block
            :size="item.size"
            :type="item.type"
            :custom-class="item.customClass"
            :plain="item.plain"
            @click="btnClick2(item)"
          >
            {{ item.text }}
          </wd-button>
        </view>
      </view>
    </view>
    <wd-popup
      v-model="show"
      custom-class="custom-class-popup"
      lock-scroll
      position="bottom"
      :safe-area-inset-bottom="true"
      :z-index="100"
      :close-on-click-modal="false"
    >
      <view class="rounded-t-10px overflow-hidden">
        <view class="flex justify-around items-center py-10px px-20px bg-#fff py-20px">
          <!-- #ifdef H5 -->
          <view class="flex justify-center gap-10px items-center" @click="wexinClick">
            <wd-img :src="wx" width="24" height="19"></wd-img>
            <view color="#888888">微信好友</view>
          </view>
          <!--  #endif -->
          <!-- #ifdef MP-WEIXIN -->
          <view class="flex justify-center gap-10px items-center">
            <wd-button class="" type="text" open-type="share">
              <view class="flex justify-center gap-10px items-center">
                <wd-img :src="wx" width="24" height="19"></wd-img>
                <view color="#888888">微信好友</view>
              </view>
            </wd-button>
          </view>
          <!--  #endif -->
          <view class="color-#e8e8e8">|</view>
          <view class="flex justify-center gap-10px items-center" @click="downLoadQrcode">
            <wd-img :src="hb" width="24" height="19"></wd-img>

            <view color="#888888">生成海报</view>
          </view>
        </view>
        <view @click="handleClose" class="py-15px color-#000 text-center bt-1px_#E8E8E8">取消</view>
      </view>
    </wd-popup>
  </view>
  <wd-overlay :show="showHb" :z-index="1000" :close-on-click-modal="false">
    <view class="h-full flex flex-col justify-center items-center bg-#000/30 px-50px box-border">
      <view class="text-right ml-auto mb-10px">
        <wd-icon name="close-circle" size="30px" color="#fff" @click="showHb = false"></wd-icon>
      </view>
      <view class="bd-1px_#888 rounded-10px p-10px box-border">
        <image :src="path" mode="widthFix" style="width: 260px; height: 415px"></image>
      </view>
      <!-- #ifdef H5-->
      <!-- <view class="text-14px color-#fff mt-20px"></view> -->
      <view class="w-full mt-20px">
        <wd-button
          :round="false"
          block
          size="large"
          type="error"
          custom-class="custom-class-mine-error"
        >
          保存
        </wd-button>
      </view>

      <!-- #endif -->
    </view>
  </wd-overlay>
  <l-painter
    isCanvasToTempFilePath
    ref="painter"
    @success="path = $event"
    custom-style="position: fixed; left: 200%"
    :painterConfig="poster"
  />
</template>

<style lang="scss" scoped>
.isShadow {
  box-shadow: 0px 0px 10px 1px rgba(0, 0, 0, 0.11);
}
:deep(.custom-class-popup) {
  @apply overflow-hidden rounded-t-20px;
}
</style>
